$(document).ready(function(){function t(t,e){var o=t[0];f=L.geoJson(e,{onEachFeature:function(t,e){var r="<b>"+String(t.properties[o])+" traffic fatalities</b><br><p> in "+t.properties.name+" in "+o+"</b>";e.bindPopup(r,{offset:L.point(0,10)}),e.setStyle(n(t.properties,o))}});{var i={"Proportional Symbols":u,Choropleth:f};L.control.layers(i).addTo(d),r(e)}}function e(t){return t>4e3?"#99000d":t>2e3?"#cb181d":t>1e3?"#ef3b2c":t>500?"#fb6a4a":t>250?"#fc9272":t>175?"#fcbba1":"#fee5d9"}function n(t,n){return{fillColor:e(t[n]),weight:2,opacity:1,color:"white",dashArray:"3",fillOpacity:.7}}function o(t){var e=[],n=1/0,o=-1/0;for(var r in t.features){var i=t.features[r].properties;for(var a in i)"STATE"!=a&&"STATE_TEXT"!=a&&(-1===$.inArray(a,e)&&e.push(a),i[a]<n&&(n=i[a]),i[a]>o&&(o=i[a]))}return{timestamps:e,min:n,max:o}}function r(t){var e=[],n=1/0,o=-1/0;for(var r in t.features){var i=t.features[r].properties;for(var a in i)"name"!=a&&"region"!=a&&"region_big"!=a&&"abbrev"!=a&&"postal"!=a&&"admin"!=a&&"name_len"!=a&&(-1===$.inArray(a,e)&&e.push(a),i[a]<n&&(n=i[a]),i[a]>o&&(o=i[a]))}return{timestamps:e,min:n,max:o}}function i(t,e){u=L.geoJson(e,{pointToLayer:function(t,e){return L.circleMarker(e,{fillColor:"#cc0000",color:"#cc0000",weight:1,fillOpacity:.6}).on({mouseover:function(){this.openPopup(),this.setStyle({color:"yellow"})},mouseout:function(){this.closePopup(),this.setStyle({color:"#537898"})}})}}).addTo(d),a(t[0])}function a(t){u.eachLayer(function(e){var n=e.feature.properties,o=s(n[t]),r="<b>"+String(n[t])+" traffic fatalities</b><br><p> in "+n.STATE+" in "+t+"</b>";e.setRadius(o),e.bindPopup(r,{offset:new L.Point(0,-o)})}),f&&f.eachLayer(function(e){var o=e.feature.properties,r="<b>"+String(o[t])+" traffic fatalities</b><br><p> in "+o.STATE+" in "+t+"</b>";e.bindPopup(r),e.setStyle(n(o,t))})}function s(t){var e=1.1,n=t*e;return Math.sqrt(n/Math.PI)}function p(t,e){function n(t){return 10*Math.round(t/10)}10>t&&(t=10);var o=L.control({position:"bottomright"});o.onAdd=function(){var o,r,i,a=L.DomUtil.create("div","legend"),p=L.DomUtil.create("div","symbolsContainer"),l=[n(t),n((e-t)/2),n(e)],c=0;L.DomEvent.addListener(a,"mousedown",function(t){L.DomEvent.stopPropagation(t)}),$(a).append("<h2 id='legendTitle'># of fatalities</h2>");for(var u=0;u<=l.length-1;u++)o=L.DomUtil.create("div","legendCircle"),r=s(l[u]),i=-r-c-2,$(o).css({width:2*r+"px",height:2*r+"px","margin-left":i+"px"}),$(o).append("<span class='legendValue'>"+l[u]+"<span>"),$(p).append(o),c=r;return $(a).append(p),a},o.addTo(d)}function l(t){var e=L.control({position:"bottomleft"});e.onAdd=function(){var e=L.DomUtil.create("input","range-slider");return L.DomEvent.addListener(e,"mousedown",function(t){L.DomEvent.stopPropagation(t)}),$(e).attr({type:"range",max:t[t.length-1],min:t[0],step:1,value:String(t[0])}).on("input change",function(){a($(this).val().toString()),$(".temporal-legend").text(this.value)}),e},e.addTo(d),c(t[0])}function c(t){var e=L.control({position:"bottomleft"});e.onAdd=function(){var e=L.DomUtil.create("output","temporal-legend");return $(e).text(t),e},e.addTo(d),$(".temporal-legend").text(t)}{var u,f,d=L.map("map",{center:[37.8,-96],zoom:4,minZoom:2});L.tileLayer("http://{s}.tile.stamen.com/toner-background/{z}/{x}/{y}.png",{attribution:"Stamen Toner Tileset"}).addTo(d)}$.getJSON("data/FAR_Accident_fatalities_year_state_geojson.json").done(function(e){$.getJSON("data/ne_50m_admin_1_states_provinces_lakes.json").done(function(n){console.log(n);var r=o(e);i(r.timestamps,e),p(r.min,r.max),l(r.timestamps),t(r.timestamps,n)})}).fail(function(){alert("There has been a problem loading the data.")})});