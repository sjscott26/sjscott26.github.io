$(document).ready(function(){function t(t){d=L.geoJson(t);var e={"Proportional Symbols":u,Choropleth:d};L.control.layers(e).addTo(f);a(t);L.geoJson(t,{style:n}).addTo(f),n(t)}function e(t){return t>4e3?"#b10026":t>2e3?"#e31a1c":t>1e3?"#fc4e2a":t>500?"#fd8d3c":t>250?"#feb24c":t>175?"#fed976":"#ffffb2"}function n(t){return{fillColor:e(t.properties.timestamps),weight:2,opacity:1,color:"white",dashArray:"3",fillOpacity:.7}}function o(t){var e=[],n=1/0,o=-1/0;for(var a in t.features){var r=t.features[a].properties;for(var i in r)"STATE"!=i&&"STATE_TEXT"!=i&&(-1===$.inArray(i,e)&&e.push(i),r[i]<n&&(n=r[i]),r[i]>o&&(o=r[i]))}return{timestamps:e,min:n,max:o}}function a(t){var e=[],n=1/0,o=-1/0;for(var a in t.features){var r=t.features[a].properties;for(var i in r)"name"!=i&&"region"!=i&&"region_big"!=i&&"abbrev"!=i&&"postal"!=i&&"admin"!=i&&"name_len"!=i&&(-1===$.inArray(i,e)&&e.push(i),r[i]<n&&(n=r[i]),r[i]>o&&(o=r[i]))}return{timestamps:e,min:n,max:o}}function r(t,e){u=L.geoJson(e,{pointToLayer:function(t,e){return L.circleMarker(e,{fillColor:"#cc0000",color:"#cc0000",weight:1,fillOpacity:.6}).on({mouseover:function(){this.openPopup(),this.setStyle({color:"yellow"})},mouseout:function(){this.closePopup(),this.setStyle({color:"#537898"})}})}}).addTo(f),i(t[0])}function i(t){u.eachLayer(function(e){var n=e.feature.properties;console.log(n);var o=s(n[t]),a="<b>"+String(n[t])+" traffic fatalities</b><br><p> in "+n.STATE+" in "+t+"</b>";e.setRadius(o),e.bindPopup(a,{offset:new L.Point(0,-o)})})}function s(t){var e=1.1,n=t*e;return Math.sqrt(n/Math.PI)}function l(t,e){function n(t){return 10*Math.round(t/10)}10>t&&(t=10);var o=L.control({position:"bottomright"});o.onAdd=function(){var o,a,r,i=L.DomUtil.create("div","legend"),l=L.DomUtil.create("div","symbolsContainer"),c=[n(t),n((e-t)/2),n(e)],p=0;L.DomEvent.addListener(i,"mousedown",function(t){L.DomEvent.stopPropagation(t)}),$(i).append("<h2 id='legendTitle'># of fatalities</h2>");for(var u=0;u<=c.length-1;u++)o=L.DomUtil.create("div","legendCircle"),a=s(c[u]),r=-a-p-2,$(o).css({width:2*a+"px",height:2*a+"px","margin-left":r+"px"}),$(o).append("<span class='legendValue'>"+c[u]+"<span>"),$(l).append(o),p=a;return $(i).append(l),i},o.addTo(f)}function c(t){var e=L.control({position:"bottomleft"});e.onAdd=function(){var e=L.DomUtil.create("input","range-slider");return L.DomEvent.addListener(e,"mousedown",function(t){L.DomEvent.stopPropagation(t)}),$(e).attr({type:"range",max:t[t.length-1],min:t[0],step:1,value:String(t[0])}).on("input change",function(){i($(this).val().toString()),$(".temporal-legend").text(this.value)}),e},e.addTo(f),p(t[0])}function p(t){var e=L.control({position:"bottomleft"});e.onAdd=function(){var e=L.DomUtil.create("output","temporal-legend");return $(e).text(t),e},e.addTo(f),$(".temporal-legend").text(t)}{var u,d,f=L.map("map",{center:[37.8,-96],zoom:4,minZoom:2});L.tileLayer("http://{s}.tile.stamen.com/toner-background/{z}/{x}/{y}.png",{attribution:"Stamen Toner Tileset"}).addTo(f)}$.getJSON("data/FAR_Accident_fatalities_year_state_geojson.json").done(function(e){$.getJSON("data/ne_50m_admin_1_states_provinces_lakes.json").done(function(n){var a=o(e);r(a.timestamps,e),l(a.min,a.max),c(a.timestamps),t(n)})}).fail(function(){alert("There has been a problem loading the data.")})});